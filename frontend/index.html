<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Finance — Minimal SPA</title>
  <style>
    :root{--bg:#0b1020;--card:#121833;--line:#1e2a56;--ink:#e6e9f5;--muted:#9aa4d6;--accent:#2a7cf7}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    a{color:inherit;text-decoration:none}
    .container{max-width:1000px;margin:0 auto;padding:16px 20px}
    header.nav{position:sticky;top:0;z-index:10;background:rgba(11,16,32,.8);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    .nav-inner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0}
    .brand{font-weight:700;letter-spacing:.3px}
    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0f1530}
    .tab.active{background:var(--accent);border-color:var(--accent)}
    .wrap{padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px;box-shadow:0 4px 16px rgba(0,0,0,.25)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    label{display:block;font-size:14px;opacity:.95;margin-top:6px}
    input,button,select{font-size:16px;padding:10px 12px;border-radius:10px;border:1px solid #2a386f;background:#0f1530;color:var(--ink)}
    input::file-selector-button{border:none;background:#23306b;color:#fff;padding:8px 10px;border-radius:8px;margin-right:10px}
    button{cursor:pointer;background:var(--accent);border:none}
    button.secondary{background:#23306b}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0f1530;padding:12px;border-radius:10px;border:1px solid #2a386f}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #223165}
    th{text-align:left;opacity:.9}
    .page{display:none}
    .page.active{display:block}
    .spacer{height:6px}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">Personal Finance</div>
      <nav class="tabs">
        <a href="#home" class="tab" data-tab="home">Home</a>
        <a href="#login" class="tab" data-tab="login">Login</a>
        <a href="#signup" class="tab" data-tab="signup">Sign Up</a>
        <a href="#settings" class="tab" data-tab="settings">Settings</a>
        <button id="btnLogout" class="tab right" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container wrap">
    <!-- HOME -->
    <section id="page-home" class="page">
      <div class="card">
        <h2>Welcome <span id="welcomeName" class="muted">(guest)</span></h2>
        <p class="muted">Use the actions below to upload a CSV and view your transactions.</p>
      </div>

      <div class="card">
        <h3>Transactions</h3>
        <div class="row">
          <button id="btnFetchTx">Fetch Transactions</button>
          <input type="file" id="csvFile" accept=".csv,text/csv" />
          <button id="btnUpload">Upload CSV</button>
          <span id="txMsg" class="muted"></span>
        </div>
        <div id="txOut" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3>Raw Responses</h3>
        <pre id="out"></pre>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="page-login" class="page">
      <div class="card">
        <h2>Login</h2>
        <div class="row">
          <label>Username
            <input id="li_username" />
          </label>
          <label>Password
            <input id="li_password" type="password" />
          </label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnLogin">Login</button>
          <span id="loginMsg" class="muted"></span>
        </div>
        <p class="muted">No account? <a href="#signup">Create one here</a>.</p>
      </div>
    </section>

    <!-- SIGNUP -->
    <section id="page-signup" class="page">
      <div class="card">
        <h2>Sign Up</h2>
        <div class="row">
          <label>Username
            <input id="su_username" />
          </label>
          <label>Email
            <input id="su_email" />
          </label>
          <label>Password
            <input id="su_password" type="password" />
          </label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnSignup">Create Account</button>
          <span id="signupMsg" class="muted"></span>
        </div>
        <p class="muted">Already have an account? <a href="#login">Login</a>.</p>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="page-settings" class="page">
      <div class="card">
        <h2>Settings</h2>
        <div class="row">
          <label>Backend URL
            <input id="baseUrl" value="http://127.0.0.1:5000" style="width:360px" />
          </label>
          <label>Token (stored in localStorage)
            <input id="token" placeholder="paste or login to set" style="width:460px" />
          </label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="saveCfg" class="secondary">Save Settings</button>
          <button id="clearToken" class="secondary">Clear Token</button>
          <span id="cfgMsg" class="muted"></span>
        </div>
      </div>
    </section>
  </main>

<script>
(function(){
  // ===== Utilities & State =====
  const $ = (id)=>document.getElementById(id);
  const qs = (sel)=>document.querySelector(sel);
  const pages = {
    home: $('page-home'),
    login: $('page-login'),
    signup: $('page-signup'),
    settings: $('page-settings')
  };

  function escapeHtml(s){
    return s.replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  }

  const store = {
    get baseUrl(){ return localStorage.getItem('pfa.baseUrl') || 'http://127.0.0.1:5000'; },
    set baseUrl(v){ localStorage.setItem('pfa.baseUrl', v); },
    get token(){ return localStorage.getItem('pfa.token') || ''; },
    set token(v){ v?localStorage.setItem('pfa.token', v):localStorage.removeItem('pfa.token'); }
  };

  function authHeaders(){
    const h = { 'Content-Type':'application/json' };
    const t = store.token.trim();
    if(t) h['Authorization'] = 'Bearer ' + t;
    return h;
  }

  function showOut(obj){ $('out') && ($('out').textContent = typeof obj==='string' ? obj : JSON.stringify(obj, null, 2)); }
  function setMsg(id, msg){ const el=$(id); if(!el) return; el.textContent = msg; setTimeout(()=>{ if(el.textContent===msg) el.textContent=''; }, 3000); }

  function decodeToken(jwt){
    try{
      const payload = jwt.split('.')[1];
      const b64 = payload.replace(/-/g,'+').replace(/_/g,'/');
      const json = decodeURIComponent(atob(b64).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));
      return JSON.parse(json);
    }catch(_){ return null; }
  }

  function updateAuthUI(){
    const loggedIn = !!store.token;
    // tabs
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    $('#btnLogout').style.display = loggedIn ? 'inline-block' : 'none';
    // welcome
    const p = decodeToken(store.token);
    $('welcomeName').textContent = loggedIn && p && p.username ? p.username : '(guest)';
    // settings inputs
    $('baseUrl') && ($('baseUrl').value = store.baseUrl);
    $('token') && ($('token').value = store.token);
  }

  function guard(route){
    const needsAuth = (route === 'home');
    if(needsAuth && !store.token){ navigate('login'); return false; }
    return true;
  }

  function navigate(route){
    if(!guard(route)) return;
    Object.values(pages).forEach(p=>p.classList.remove('active'));
    const page = pages[route] || pages.home;
    page.classList.add('active');
    // highlight tab
    document.querySelectorAll('[data-tab]').forEach(el=>{
      el.classList.toggle('active', el.getAttribute('data-tab')===route);
    });
    // push hash if changed
    if(location.hash !== '#'+route){ location.hash = '#'+route; }
    updateAuthUI();
  }

  function routeFromHash(){
    const r = (location.hash || '#').replace('#','') || 'home';
    if(r==='home' && !store.token) return 'login';
    return ['home','login','signup','settings'].includes(r) ? r : 'home';
  }

  // ===== Actions =====
  $('btnLogin') && ($('btnLogin').onclick = async ()=>{
    const body = { username: $('li_username').value.trim(), password: $('li_password').value };
    try{
      const r = await fetch(store.baseUrl + '/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const data = await r.json(); showOut(data);
      if(r.ok && data.token){
        store.token = data.token; $('token') && ($('token').value = data.token);
        setMsg('loginMsg','Logged in'); navigate('home');
      } else setMsg('loginMsg', data.error || 'Login failed');
    }catch(e){ showOut(String(e)); setMsg('loginMsg','Network error'); }
  });

  $('btnSignup') && ($('btnSignup').onclick = async ()=>{
    const body = { username: $('su_username').value.trim(), email: $('su_email').value.trim(), password: $('su_password').value };
    try{
      const r = await fetch(store.baseUrl + '/signup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const data = await r.json(); showOut(data);
      if(r.ok){ setMsg('signupMsg','Account created — please log in'); navigate('login'); $('li_username').value = $('su_username').value; }
      else setMsg('signupMsg', data.error || 'Signup failed');
    }catch(e){ showOut(String(e)); setMsg('signupMsg','Network error'); }
  });

  $('btnLogout').onclick = ()=>{ store.token=''; updateAuthUI(); navigate('login'); };

  $('saveCfg') && ($('saveCfg').onclick = ()=>{ store.baseUrl = $('baseUrl').value.trim(); store.token = $('token').value.trim(); updateAuthUI(); setMsg('cfgMsg','Saved'); });
  $('clearToken') && ($('clearToken').onclick = ()=>{ store.token=''; updateAuthUI(); setMsg('cfgMsg','Token cleared'); });

  $('btnFetchTx') && ($('btnFetchTx').onclick = async ()=>{
    try{
      const r = await fetch(store.baseUrl + '/transactions', { headers: authHeaders() });
      const data = await r.json(); showOut(data);
      const tx = (r.ok && Array.isArray(data.transactions)) ? data.transactions : [];
      if(r.ok){ renderTable(tx); setMsg('txMsg','Fetched ' + tx.length + ' items'); }
      else { $('txOut').innerHTML = ''; setMsg('txMsg', data.error || 'Failed'); }
    }catch(e){ showOut(String(e)); setMsg('txMsg','Network error'); }
  });

  $('btnUpload') && ($('btnUpload').onclick = async ()=>{
    const file = $('csvFile').files[0]; if(!file){ setMsg('txMsg','Pick a CSV'); return; }
    const form = new FormData(); form.append('file', file);
    try{
      const r = await fetch(store.baseUrl + '/upload', { method:'POST', headers: { 'Authorization': authHeaders()['Authorization'] || '' }, body: form });
      const data = await r.json(); showOut(data);
      setMsg('txMsg', r.ok ? 'Upload ok' : (data.error || 'Upload failed'));
    }catch(e){ showOut(String(e)); setMsg('txMsg','Network error'); }
  });

  function renderTable(rows){
    if(!$('txOut')) return;
    if(!rows || rows.length===0){ $('txOut').innerHTML = '<p class="muted">No transactions</p>'; return; }
    const cols = Object.keys(rows[0]);
    const head = '<tr>' + cols.map(c=>`<th>${c}</th>`).join('') + '</tr>';
    const body = rows.map(r=>'<tr>'+cols.map(c=>`<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('')+'</tr>').join('');
    $('txOut').innerHTML = `<table>${head}${body}</table>`;
  }

  // ===== Router boot =====
  window.addEventListener('hashchange', ()=> navigate(routeFromHash()));
  document.addEventListener('DOMContentLoaded', ()=>{
    updateAuthUI();
    navigate(routeFromHash());
  });
})();
</script>
</body>
</html>