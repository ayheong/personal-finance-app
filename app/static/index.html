<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Finance â€” Minimal SPA</title>
  <style>
    :root {
      --bg:#0b1020;
      --card:#121833;
      --line:#1e2a56;
      --ink:#e6e9f5;
      --muted:#9aa4d6;
      --accent:#2a7cf7;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--ink);
    }

    a { color: inherit; text-decoration: none; }

    .container { max-width: 1000px; margin: 0 auto; padding: 16px 20px; }

    header.nav {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(11,16,32,.8);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
    }

    .nav-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 0;
    }

    .brand { font-weight: 700; letter-spacing: .3px; }

    .tabs { display: flex; gap: 10px; flex-wrap: wrap; }

    .tab {
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #0f1530;
      cursor: pointer;
    }
    .tab.active { background: var(--accent); border-color: var(--accent); }

    .wrap { padding: 20px; }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,.25);
    }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }

    label { display: block; font-size: 14px; opacity: .95; margin-top: 6px; }

    input, button, select {
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2a386f;
      background: #0f1530;
      color: var(--ink);
    }

    input::file-selector-button {
      border: none;
      background: #23306b;
      color: #fff;
      padding: 8px 10px;
      border-radius: 8px;
      margin-right: 10px;
    }

    button { cursor: pointer; background: var(--accent); border: none; }
    button.secondary { background: #23306b; }

    .muted { color: var(--muted); }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #223165; }
    th { text-align: left; opacity: .9; }

    .page { display: none; }
    .page.active { display: block; }

    .spacer { height: 6px; }
    .right { margin-left: auto; }
  </style>
</head>
<body>
  <header class="nav">
    <div class="container nav-inner">
      <div class="brand">Personal Finance</div>
      <nav class="tabs">
        <a href="#home" class="tab" data-tab="home" id="tabHome" style="display:none">Home</a>
        <a href="#login" class="tab" data-tab="login" id="tabLogin">Login</a>
        <a href="#signup" class="tab" data-tab="signup" id="tabSignup">Sign Up</a>
        <a href="#settings" class="tab" data-tab="settings">Settings</a>
        <button id="btnLogout" class="tab right" style="display:none">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container wrap">
    <!-- HOME -->
    <section id="page-home" class="page">
      <div class="card">
        <h2>Welcome <span id="welcomeName" class="muted">(guest)</span></h2>
        <p class="muted">Use the actions below to upload a CSV and view your transactions.
          To start, select the corresponding account type and institution and upload your CSV.
          To view all of your uploaded transactions, select fetch transactions.
        </p>
      </div>

      <div class="card">
        <h2>Transactions</h2>
        <div class="row">
          <input type="file" id="csvFile" accept=".csv,text/csv" />

          <select id="accountType">
            <option value="" disabled selected>Select Account Type...</option>
            <option value="bank">Bank Account</option>
            <option value="card">Credit Card</option>
          </select>

          <select id="institution" disabled>
            <option value="" disabled selected>Select Institution...</option>
          </select>

          <span id="txMsg" class="muted"></span>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button id="btnUpload">Upload CSV</button>
          <button id="btnFetchTx">Fetch Transactions</button>
          <span id="txMsg2" class="muted"></span>
        </div>

        <!-- Progress bar -->
        <div id="uploadProgress" style="margin-top:10px; display:none;">
          <div style="background:#23306b; border-radius:8px; overflow:hidden; height:14px;">
            <div id="uploadBar" style="width:0%; height:100%; background:#2a7cf7; transition: width 0.3s;"></div>
          </div>
          <p id="uploadStatus" class="muted" style="margin-top:4px;">Uploading...</p>
        </div>

        <div id="txOut" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- LOGIN -->
    <section id="page-login" class="page">
      <div class="card">
        <h2>Login</h2>
        <div class="row">
          <label>Username <input id="li_username" /></label>
          <label>Password <input id="li_password" type="password" /></label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnLogin">Login</button>
          <span id="loginMsg" class="muted"></span>
        </div>
        <p class="muted">No account? <a href="#signup">Create one here</a>.</p>
      </div>
    </section>

    <!-- SIGNUP -->
    <section id="page-signup" class="page">
      <div class="card">
        <h2>Sign Up</h2>
        <div class="row">
          <label>Username <input id="su_username" /></label>
          <label>Email <input id="su_email" /></label>
          <label>Password <input id="su_password" type="password" /></label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="btnSignup">Create Account</button>
          <span id="signupMsg" class="muted"></span>
        </div>
        <p class="muted">Already have an account? <a href="#login">Login</a>.</p>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="page-settings" class="page">
      <div class="card">
        <h2>Settings</h2>
        <div class="row">
          <label>Backend URL <input id="baseUrl" value="http://127.0.0.1:5000" style="width:360px" /></label>
        </div>
        <div class="spacer"></div>
        <div class="row">
          <button id="saveCfg" class="secondary">Save Settings</button>
          <button id="clearToken" class="secondary">Clear Login Session</button>
          <span id="cfgMsg" class="muted"></span>
        </div>
      </div>
    </section>
  </main>

<script>

  const institutions = {
    bank: [
      { value: "wells_fargo_debit", label: "Wells Fargo" },
      { value: "chase_debit", label: "Chase" },
    ],
    card: [
      { value: "chase_credit", label: "Chase" },
      { value: "amex_credit", label: "American Express" }
    ]
  };

  const acctType = document.getElementById("accountType");
  const instSelect = document.getElementById("institution");

  acctType.addEventListener("change", function() {
    instSelect.innerHTML = '<option value="" disabled selected>Select Institution...</option>';

    const type = this.value;
    if (institutions[type]) {
      institutions[type].forEach(opt => {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.label;
        instSelect.appendChild(o);
      });
      instSelect.disabled = false;
    } else {
      instSelect.disabled = true;
    }
  });

(function() {
  const $ = (id) => document.getElementById(id);

  // Pages
  const pages = {
    home: $('page-home'),
    login: $('page-login'),
    signup: $('page-signup'),
    settings: $('page-settings')
  };

  // Upload state
  let currentUploadController = null;
  let uploadInProgress = false;
  let fakeProgressTimer = null;

  // Local storage wrapper
  const store = {
    get baseUrl() { return localStorage.getItem('pfa.baseUrl') || 'http://127.0.0.1:5000'; },
    set baseUrl(v) { localStorage.setItem('pfa.baseUrl', v); },
    get token() { return localStorage.getItem('pfa.token') || ''; },
    set token(v) { v ? localStorage.setItem('pfa.token', v) : localStorage.removeItem('pfa.token'); }
  };

  // Decode JWT
  function decodeToken(jwt) {
    try {
      const payload = jwt.split('.')[1];
      return JSON.parse(atob(payload.replace(/-/g,'+').replace(/_/g,'/')));
    } catch (_) {
      return null;
    }
  }

  // Update nav + UI state
  function updateAuthUI() {
    const loggedIn = !!store.token;
    $('btnLogout').style.display = loggedIn ? 'inline-block' : 'none';
    $('tabHome').style.display = loggedIn ? 'inline-block' : 'none';
    $('tabLogin').style.display = loggedIn ? 'none' : 'inline-block';
    $('tabSignup').style.display = loggedIn ? 'none' : 'inline-block';

    const p = decodeToken(store.token);
    $('welcomeName').textContent = loggedIn && p && p.username ? p.username : '(guest)';
    $('baseUrl').value = store.baseUrl;
  }

  // Route guard
  function guard(route) {
    if (route === 'home' && !store.token) {
      navigate('login');
      return false;
    }
    return true;
  }

  // Navigation
  function navigate(route) {
    if (!guard(route)) return;

    Object.values(pages).forEach(p => p.classList.remove('active'));
    (pages[route] || pages.home).classList.add('active');

    document.querySelectorAll('[data-tab]').forEach(el => {
      el.classList.toggle('active', el.getAttribute('data-tab') === route);
    });

    if (location.hash !== '#' + route) location.hash = '#' + route;
    updateAuthUI();
  }

  function routeFromHash() {
    const r = (location.hash || '#').replace('#','') || 'home';
    if (r === 'home' && !store.token) return 'login';
    return ['home','login','signup','settings'].includes(r) ? r : 'home';
  }

  // Helpers
  function setMsg(id, msg) {
    $(id).textContent = msg;
  }

  function headers() {
    const h = { 'Content-Type': 'application/json' };
    if (store.token) h['Authorization'] = 'Bearer ' + store.token;
    return h;
  }

  function confirmCancelJob(next) {
    if (uploadInProgress) {
      if (confirm("An upload is still running. Cancel it and continue?")) {
        if (currentUploadController) currentUploadController.abort();
        uploadInProgress = false;
        stopFakeProgress();
        next();
      }
    } else {
      next();
    }
  }

  // Fake progress bar
  function startFakeProgress() {
    $('uploadProgress').style.display = 'block';
    $('uploadBar').style.width = '0%';
    $('uploadStatus').textContent = 'Uploading...';

    let p = 0;
    fakeProgressTimer = setInterval(() => {
      if (p < 90) {
        p += Math.random() * 1;
        $('uploadBar').style.width = Math.min(p, 90) + '%';
      }
    }, 400);
  }

  function stopFakeProgress(done) {
    clearInterval(fakeProgressTimer);
    $('uploadBar').style.width = '100%';
    $('uploadStatus').textContent = done ? 'Done!' : 'Cancelled';

    setTimeout(() => {
      $('uploadProgress').style.display = 'none';
    }, 1500);
  }

  // ================
  // Event Handlers
  // ================

  // Signup
  $('btnSignup').onclick = async () => {
    const base = store.baseUrl;
    const body = {
      username: $('su_username').value.trim(),
      email: $('su_email').value.trim(),
      password: $('su_password').value
    };

    try {
      const r = await fetch(base + '/signup', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const d = await r.json();
      if (r.ok) {
        setMsg('signupMsg','Signup ok');
        navigate('login');
      } else {
        setMsg('signupMsg', d.error || 'Signup failed');
      }
    } catch(e) {
      setMsg('signupMsg','Network error');
    }
  };

  // Login
  $('btnLogin').onclick = async () => {
    const base = store.baseUrl;
    const body = {
      username: $('li_username').value.trim(),
      password: $('li_password').value
    };

    try {
      const r = await fetch(base + '/login', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const d = await r.json();

      if (r.ok && d.token) {
        store.token = d.token;
        updateAuthUI();
        setMsg('loginMsg','Logged in!');
        navigate('home');
      } else {
        setMsg('loginMsg', d.error || 'Login failed');
      }
    } catch(e) {
      setMsg('loginMsg','Network error');
    }
  };

  // Fetch Transactions
  $('btnFetchTx').onclick = async () => {
    const base = store.baseUrl;
    try {
      const r = await fetch(base + '/transactions', { headers: headers() });
      const d = await r.json();

      if (r.ok && Array.isArray(d.transactions)) {
        renderTable(d.transactions);
        setMsg('txMsg','Fetched ' + d.transactions.length + ' items');
      } else {
        $('txOut').innerHTML = '<p class="muted">No transactions</p>';
        setMsg('txMsg', (d && d.error) || 'Failed');
      }
    } catch(e) {
      setMsg('txMsg','Network error');
    }
  };

  // Upload CSV
  $('btnUpload').onclick = async () => {
    const base = $('baseUrl').value.trim();
    const file = $('csvFile').files[0];
    const institution = $('institution').value;
    if (!file) {
      setMsg('txMsg','Please select a CSV file to upload');
      return;
    }
    if (!institution) {
      setMsg('txMsg','Please select CSV details');
      return;
    }

    currentUploadController = new AbortController();
    uploadInProgress = true;
    startFakeProgress();

    const form = new FormData();
    form.append('file', file);
    form.append("csv_type", institution);
    form.append('accountType', accountType);
    form.append('institution', institution);

    try {
      const r = await fetch(base + '/upload', {
        method: 'POST',
        headers: { 'Authorization': headers()['Authorization'] || '' },
        body: form,
        signal: currentUploadController.signal
      });
      const d = await r.json();

      uploadInProgress = false;
      stopFakeProgress(r.ok);
      setMsg('txMsg', r.ok ? 'Upload ok' : (d.error || 'Upload failed'));
    } catch(e) {
      if (e.name === 'AbortError') {
        setMsg('txMsg','Upload cancelled');
      } else {
        setMsg('txMsg','Network error');
      }
      uploadInProgress = false;
      stopFakeProgress(false);
    }
  };

  // Navigation + Logout
  document.querySelectorAll('[data-tab]').forEach(tab => {
    tab.addEventListener('click', e => {
      e.preventDefault();
      const t = tab.getAttribute('data-tab');
      confirmCancelJob(() => navigate(t));
    });
  });

  $('btnLogout').onclick = () =>
    confirmCancelJob(() => {
      store.token = '';
      updateAuthUI();
      navigate('login');
    });

  $('saveCfg').onclick = () => {
    store.baseUrl = $('baseUrl').value.trim();
    updateAuthUI();
    setMsg('cfgMsg','Saved');
  };

  $('clearToken').onclick = () => {
    store.token = '';
    updateAuthUI();
    setMsg('cfgMsg','Token cleared');
    navigate('login');
  };

  // Init
  window.addEventListener('hashchange', () => navigate(routeFromHash()));
  document.addEventListener('DOMContentLoaded', () => {
    updateAuthUI();
    navigate(routeFromHash());
  });

  window.addEventListener("beforeunload", (e) => {
    if (uploadInProgress) {
      e.preventDefault();
      e.returnValue = "An upload is in progress. Leave anyway?";
    }
  });

  // Render transactions table
  function renderTable(rows) {
    if (!rows || rows.length === 0) {
      $('txOut').innerHTML = '<p class="muted">No transactions</p>';
      return;
    }

    const cols = ['amount','category','description'];
    const head = '<tr>' + cols.map(c => `<th>${c}</th>`).join('') + '</tr>';
    const body = rows.map(r =>
      '<tr>' + cols.map(c => `<td>${escapeHtml(String(r[c] ?? ''))}</td>`).join('') + '</tr>'
    ).join('');

    $('txOut').innerHTML = `<table>${head}${body}</table>`;
  }

  function escapeHtml(s) {
    return s.replace(/[&<>"]/g, m =>
      ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])
    );
  }
})();
</script>
</body>
</html>
